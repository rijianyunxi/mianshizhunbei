<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue 响应式 V-Model 模拟</title>
</head>

<body>
    <div id="app">
        <input type="text" v-model="value" /> 
        <p>当前值: <span id="display-value"></span></p>
    </div>

    <script>
        // =========================================================
        // 1. 依赖收集器 (Dep): 用于收集依赖，通知更新
        // =========================================================
        class Dep {
            constructor() {
                this.subs = []; // 存储所有观察者 (Watcher)
            }
            // 添加观察者
            addSub(sub) {
                this.subs.push(sub);
            }
            // 通知所有观察者进行更新
            notify() {
                this.subs.forEach(sub => sub.update());
            }
        }

        // =========================================================
        // 2. 视图观察者 (Watcher): 用于订阅数据变化，执行视图更新
        // =========================================================
        class Watcher {
            constructor(vm, exp, cb) {
                this.vm = vm;
                this.exp = exp;
                this.cb = cb;
                this.value = this.get(); // 首次执行，触发 getter 收集依赖
            }

            get() {
                Dep.target = this; // 挂载当前 Watcher 到全局
                let value = this.vm[this.exp];
                Dep.target = null; // 取消挂载
                return value;
            }

            update() {
                this.cb(); // 执行回调，更新视图
            }
        }

        // =========================================================
        // 3. 数据劫持 (Observer): 为 data 中的属性添加 getter/setter
        // =========================================================
        function defineReactive(obj, key, val) {
            const dep = new Dep(); // 为每个属性创建一个依赖收集器

            Object.defineProperty(obj, key, {
                enumerable: true,
                configurable: true,
                get() {
                    // 依赖收集：当有 Watcher 访问该属性时，将其添加到依赖中
                    if (Dep.target) {
                        dep.addSub(Dep.target);
                    }
                    return val;
                },
                set(newVal) {
                    if (newVal === val) return;
                    val = newVal;
                    // 通知更新：当属性被修改时，通知所有依赖该属性的 Watcher 进行更新
                    dep.notify(); 
                }
            });
        }
        
        function observe(data) {
            if (!data || typeof data !== 'object') {
                return;
            }
            Object.keys(data).forEach(key => {
                defineReactive(data, key, data[key]);
            });
        }

        // =========================================================
        // 4. Vue 类：负责初始化、数据代理和挂载 DOM
        // =========================================================
        class Vue {
            constructor(el, options) {
                this.$el = document.querySelector(el);
                this.$options = options;
                this.$data = this.$options.data(); // 获取数据对象
                
                // 1. 数据劫持：将 $data 中的属性变为响应式
                observe(this.$data);
                
                // 2. 数据代理：将 $data 属性代理到 this 上 (this.value -> this.$data.value)
                this._proxyData(this.$data);

                // 3. 模板编译与绑定：找到 v-model 元素并建立 Watcher
                this.compile();
            }

            // 代理 $data 到 this
            _proxyData(data) {
                Object.keys(data).forEach(key => {
                    Object.defineProperty(this, key, {
                        enumerable: true,
                        configurable: true,
                        get() {
                            return this.$data[key];
                        },
                        set(newVal) {
                            this.$data[key] = newVal;
                        }
                    });
                });
            }

            // 编译/挂载逻辑
            compile() {
                const inputElement = this.$el.querySelector('[v-model]');
                const attr = inputElement.getAttribute('v-model'); // 'value'
                const displayElement = this.$el.querySelector('#display-value');

                // A. 实现 V-Model (数据到视图，视图到数据)
                // 视图更新 Watcher (数据到视图)
                new Watcher(this, attr, () => {
                    inputElement.value = this[attr]; // 1. 绑定 input 
                    displayElement.textContent = this[attr]; // 2. 绑定 p 标签
                });
                
                // 视图事件监听 (视图到数据)
                inputElement.addEventListener('input', (e) => {
                    this[attr] = e.target.value; // 修改 this.value，触发 setter
                });
                
                // 首次初始化
                inputElement.value = this.$data[attr];
                displayElement.textContent = this.$data[attr];
            }
        }

        // =========================================================
        // 5. 实例化
        // =========================================================
        const vm = new Vue('#app', {
            data() {
                return {
                    value: 'Hello Vue'
                }
            },
        });
    </script>
</body>

</html>